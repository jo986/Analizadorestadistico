<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador Estadístico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Librería para leer Excel (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- LIBRERÍAS DE GRÁFICOS (Chart.js + Plugins) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            background-image: linear-gradient(135deg, #eef2ff 0%, #f0f2f5 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        main { flex: 1; }
        .main-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 30px -15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .accordion-item { margin-bottom: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; overflow: hidden; }
        .accordion-item summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: #f9fafb;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .accordion-item summary:hover { background-color: #f3f4f6; }
        .accordion-item summary::after { content: '▼'; font-size: 0.8rem; transition: transform 0.3s ease-in-out; color: #6b7280; }
        .accordion-item[open] > summary::after { transform: rotate(-180deg); }
        .accordion-content {
            padding: 1.5rem; 
            border-top: 1px solid #e5e7eb;
            background-color: #fff;
        }
        .calculation-step { margin-bottom: 1.5rem; }
        .calculation-step:last-child { margin-bottom: 0; }
        .calculation-step h4 {
            font-weight: 600; color: #4b5563; margin-bottom: 0.75rem;
            border-bottom: 2px solid #10b981; padding-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;
        }
        .scrollable-equation {
            overflow-x: auto;
            white-space: nowrap;
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        /* Chart Styles Updated */
        .chart-container { 
            width: 100%; 
            padding: 1rem; 
            position: relative; 
            height: 500px; /* Altura generosa para el gráfico */
            display: flex;
            justify-content: center;
        }
        
        /* Tables */
        .result-table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
        .result-table th, .result-table td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: center; font-size: 0.75rem; }
        .result-table th { background-color: #f9fafb; font-weight: 600; }
        .summary-table { margin-top: 1rem; }
        .summary-table td { padding: 0.75rem 1rem; font-size: 0.9rem; text-align: left;}
        .summary-table td:first-child { font-weight: 600; color: #374151; }
        .summary-table td:last-child { font-weight: 600; color: #4f46e5; text-align: right; }
        /* WhatsApp Button */
        .whatsapp-float { position: fixed; width: 60px; height: 60px; bottom: 40px; right: 40px; background-color: #25d366; color: #FFF; border-radius: 50px; text-align: center; font-size: 30px; box-shadow: 2px 2px 3px #999; z-index: 100; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .whatsapp-float:hover { transform: scale(1.1); background-color: #1DA851; }
        .whatsapp-float svg { width: 35px; height: 35px; }
        /* Footer */
        footer.app-footer { background-color: #111827; color: #9ca3af; padding: 2rem 1rem; margin-top: 2rem; border-top: 5px solid #4f46e5; }
        footer.app-footer h4 { color: #e5e7eb; font-weight: 600; margin-bottom: 1rem; }
        footer.app-footer ul { list-style: none; padding: 0; }
        footer.app-footer a { color: #9ca3af; text-decoration: none; transition: color 0.2s; }
        footer.app-footer a:hover { color: #e5e7eb; }
        footer.app-footer .copyright { margin-top: 2rem; border-top: 1px solid #374151; padding-top: 1rem; font-size: 0.875rem; text-align: center; }
        /* Animations & Utils */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .copy-btn { background: none; border: none; cursor: pointer; color: #9ca3af; }
        .copy-btn:hover { color: #4f46e5; }
        .error-box {
            background-color: #fff1f2;
            border: 1px solid #fecaca;
            color: #be123c;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
        }
        .error-box h3 { font-weight: 600; color: #be123c; }
        .error-box code { background-color: #fee2e2; padding: 0.1rem 0.25rem; border-radius: 0.25rem; font-family: monospace; }
        .notice-box {
            background-color: #fffbeb;
            border: 1px solid #fde68a;
            color: #b45309;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
        }

        /* Botón Markdown */
        #copyMarkdownContainer { margin-top: 2rem; display: none; text-align: center; }
        .markdown-btn {
            background-color: #1f2937; color: #f3f4f6; font-family: monospace; padding: 1rem 2rem; border-radius: 0.75rem;
            font-weight: bold; display: inline-flex; align-items: center; transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .markdown-btn:hover {
            background-color: #111827; transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Modal de Donación */
        #donationModal {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.85); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        #donationModal.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; width: 90%; max-width: 500px; border-radius: 1.5rem;
            padding: 2rem; text-align: center; position: relative;
            transform: scale(0.9); transition: transform 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        #donationModal.active .modal-content { transform: scale(1); }
        .modal-close { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; color: #6b7280; cursor: pointer; }

        @media (min-width: 640px) { /* sm */
            .result-table th, .result-table td { font-size: 0.875rem; }
            .chart-container { padding: 1rem; height: 500px; } 
            .bar-label, .interval-label { font-size: 0.875rem; }
            .whatsapp-float { bottom: 30px; right: 30px; }
        }
        @media (min-width: 768px) { /* md */
            footer.app-footer { padding: 3rem 2rem; }
        }
    </style>
</head>
<body class="p-2 sm:p-4">

    <main class="w-full max-w-6xl mx-auto space-y-8" id="mainContent">
        <div class="main-card p-6 sm:p-8" id="inputCard">
            <div class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Analizador Estadístico</h1>
                <p class="text-gray-500 mt-2 text-md sm:text-lg">Una herramienta interactiva para el análisis descriptivo de datos.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label for="rawData" class="block text-md font-medium text-gray-700">Pega tu base de datos:</label>
                        <button id="clearDataBtn" class="flex items-center text-xs text-red-500 hover:text-red-700 font-medium transition duration-150">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            Limpiar
                        </button>
                    </div>
                    <textarea id="rawData" rows="10" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" placeholder="Ej: 4.68, 6.27, 7.70, 4.99... o Bueno, Malo, Regular..."></textarea>
                    
                    <input type="file" id="excelUpload" class="hidden" accept=".xlsx, .xls, .csv">
                    <button id="uploadExcelBtn" class="w-full mt-4 bg-green-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h5v2H5a1 1 0 01-1-1zm7 1v-2h5v1a1 1 0 01-1 1h-4zm5-4H4V7a1 1 0 011-1h10a1 1 0 011 1v2z"></path></svg>
                        Subir Archivo Excel (.xlsx, .xls)
                    </button>
                    <div id="fileMessage" class="text-xs text-center mt-2"></div>
                    
                    <!-- Acordeón de Ayuda Excel -->
                    <details class="accordion-item mt-4">
                        <summary class="text-sm font-medium text-gray-700 rounded-lg">¿Cómo preparar tu archivo Excel?</summary>
                        <div class="accordion-content text-sm text-gray-600 space-y-4">
                            <p>Para asegurar una carga correcta, tu archivo Excel debe seguir este formato simple:</p>
                            <img src="https://i.ibb.co/hxXC3ZMY/image.png" alt="Ejemplo de formato Excel" class="w-full rounded-md border shadow-sm">
                            <ul class="list-disc list-inside space-y-1">
                                <li>Los datos deben estar en la **primera hoja** del archivo.</li>
                                <li>Los datos deben estar en la **primera columna (Columna A)**.</li>
                                <li>El programa **ignora automáticamente la primera fila (Fila 1)**, asumiendo que es un encabezado.</li>
                                <li>Los datos deben empezar desde la **Fila 2**.</li>
                            </ul>
                        </div>
                    </details>

                </div>
                <div class="space-y-6">
                      <div>
                        <label for="variableName" class="block text-md font-medium text-gray-700 mb-2">Nombre de la Variable (Requerido):</label>
                        <input type="text" id="variableName" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" placeholder="Ej: Nivel de pH o Calidad de Servicio">
                    </div>
                      <div>
                        <label for="histColor" class="block text-md font-medium text-gray-700 mb-2">Color de las Barras:</label>
                        <input type="color" id="histColor" value="#34d399" class="w-full h-14 p-1 border border-gray-300 rounded-xl cursor-pointer shadow-sm">
                    </div>
                    
                    <div class="flex flex-col space-y-4">
                        <button id="analyzeBtn" class="w-full bg-indigo-600 text-white font-bold py-4 px-4 rounded-xl hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                            <svg id="analyzeBtnIcon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2z"></path></svg>
                            <span id="analyzeBtnText">Analizar</span>
                        </button>
                        <p class="text-xs text-gray-600 text-center">Cargar datos de ejemplo:</p>
                        <div class="grid grid-cols-2 gap-4 w-full">
                           <button id="loadSampleIntBtn" class="w-full bg-emerald-500 text-white font-bold py-2 px-3 rounded-xl hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg text-sm">Enteros (200)</button>
                           <button id="loadSampleDec2Btn" class="w-full bg-teal-500 text-white font-bold py-2 px-3 rounded-xl hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg text-sm">Decimales (2dp)</button>
                           <button id="loadSampleDec4Btn" class="w-full bg-cyan-500 text-white font-bold py-2 px-3 rounded-xl hover:bg-cyan-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg text-sm">Decimales (4dp)</button>
                           <button id="loadSampleQualBtn" class="w-full bg-sky-500 text-white font-bold py-2 px-3 rounded-xl hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg text-sm">Cualitativos (200)</button>
                        </div>
                    </div>
                      <p class="text-xs text-gray-500 text-center mt-2">Nota: Grandes cantidades de datos (>10,000) pueden ralentizar el navegador.</p>
                </div>
            </div>
        </div>
        
        <div id="results" class="space-y-8">
             <div id="initialState" class="main-card p-8 text-center fade-in">
                <svg class="w-24 h-24 mx-auto text-indigo-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V8a2 2 0 00-2-2H6a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                <h2 class="text-2xl font-bold text-gray-700 mt-4">Listo para Analizar</h2>
                <p class="text-gray-500 mt-2">Pega tus datos en el área de texto, carga un archivo Excel o usa un ejemplo para comenzar.</p>
            </div>
        </div>
        
        <!-- Botón para copiar Markdown (oculto inicialmente) -->
        <div id="copyMarkdownContainer">
            <div class="bg-gray-100 p-4 rounded-lg mb-4 text-sm text-gray-600 max-w-2xl mx-auto">
                <p class="font-semibold mb-2">Exportar Análisis Completo:</p>
                <p class="mb-2">El siguiente reporte en código Markdown incluye <strong>todas las fórmulas, desarrollos y resultados</strong> detallados.</p>
                <p class="mb-3">Puedes pegar este código en editores compatibles para convertirlo a <strong>Word, Excel, PowerPoint, PDF o LaTeX</strong>. Se recomienda usar la versión web de un lector de Markdown para visualizarlo y exportarlo.</p>
                <a href="https://snip.mathpix.com/" target="_blank" class="text-indigo-600 hover:text-indigo-800 underline font-medium">Ir al Lector Markdown Web Recomendado (Click aquí)</a>
                <p class="text-xs mt-1 text-gray-500">(Recuerda loguearte o registrarte en el lector web para guardar tus archivos)</p>
            </div>
            <button id="btnCopyMarkdown" class="markdown-btn">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                Copiar Reporte Markdown (Código)
            </button>
        </div>

    </main>
    
    <a href="https://wa.me/51903422507" class="whatsapp-float" target="_blank" rel="noopener noreferrer" aria-label="Contactar por WhatsApp">
        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12.04 2c-5.46 0-9.9 4.44-9.9 9.9 0 1.77.47 3.45 1.37 4.9L2 22l5.25-1.37c1.45.9 3.13 1.37 4.9 1.37 5.46 0 9.9-4.44 9.9-9.9s-4.44-9.9-9.9-9.9zm0 18c-1.58 0-3.06-.45-4.34-1.23l-.31-.18-3.26.85.87-3.18-.2-.33c-.8-1.29-1.23-2.77-1.23-4.31 0-4.31 3.5-7.81 7.81-7.81s7.81 3.5 7.81 7.81-3.5 7.81-7.81 7.81zm4.07-5.96c-.22-.11-.79-.39-.92-.44-.13-.05-.22-.05-.31.05-.09.11-.34.44-.42.54-.07.11-.15.11-.28.05-.13-.05-.55-.2-.7-.29-.14-.08-.28-.18-.4-.26-.82-.54-1.37-1.29-1.82-2.02-.12-.22-.01-.34.1-.44.09-.09.2-.23.29-.34.09-.11.13-.19.18-.31.05-.13.03-.24-.01-.34-.05-.08-.31-.76-.42-1.04-.11-.27-.22-.24-.31-.24h-.31c-.13 0-.34.05-.52.26-.18.22-.69.67-.69 1.62s.71 1.88.81 2c.09.11 1.39 2.13 3.41 3.01.49.21.88.34 1.18.44.49.17.63.14.86.12.24-.02.79-.32.9-.63.11-.31.11-.58.08-.63-.04-.04-.13-.09-.28-.15z"/></svg>
    </a>

    <footer class="app-footer">
        <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-8">
            <div class="lg:col-span-1">
                <h4 class="text-xl">Sobre el Programa</h4>
                <ul><li>Análisis Descriptivo</li><li>Visualización de Datos</li></ul>
            </div>
            
            <div class="lg:col-span-2">
                <h4 class="text-xl">Creador</h4>
                <div class="flex flex-col sm:flex-row items-center gap-4 text-center sm:text-left">
                    <div class="flex-shrink-0 flex gap-4">
                        <img src="https://i.ibb.co/3yL8JX3f/2.png" alt="Logo UNAS" class="h-20 w-20 object-contain">
                        <img src="https://i.ibb.co/GvwLjND4/1.png" alt="Logo Escuela" class="h-20 w-20 object-contain">
                    </div>
                    <div>
                        <p class="text-lg font-semibold text-white">José Caballero Livaque</p>
                        <p class="text-sm mt-1">Estudiante, <span class="font-medium">UNIVERSIDAD NACIONAL AGRARIA DE LA SELVA</span></p>
                        <p class="text-xs text-gray-400 mt-1">FACULTAD DE RECURSOS NATURALES RENOVABLES</p>
                        <p class="text-xs text-gray-400">ESCUELA PROFESIONAL DE INGENIERÍA EN CONSERVACIÓN DE SUELOS Y AGUA</p>
                    </div>
                </div>
            </div>

            <div>
                <h4 class="text-xl">Soporte y Donaciones</h4>
                <ul>
                    <li><a href="https://wa.me/51903422507" target="_blank">Contactar por WhatsApp</a></li>
                    <li>Reportar un error</li>
                </ul>
                <p class="text-sm mt-4 mb-2">Si esta herramienta te es útil, considera apoyar su desarrollo:</p>
                <img src="https://i.ibb.co/zh4TR6tD/Imagen-de-Whats-App-2025-10-18-a-las-00-25-27-96e5a932.jpg" alt="Código QR para donar" class="w-24 h-24 rounded-lg shadow-md">
            </div>
        </div>
        <div class="copyright">&copy; 2025 P4INN.</div>
    </footer>

    <!-- MODAL DE DONACIÓN -->
    <div id="donationModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">×</span>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">¡Apoya el Desarrollo!</h3>
            <p class="text-gray-600 mb-4">Si esta herramienta te ha sido útil para tus trabajos, considera hacer una pequeña donación para mantenerla activa y gratuita.</p>
            
            <div class="flex justify-center mb-6">
                <img src="https://i.ibb.co/zh4TR6tD/Imagen-de-Whats-App-2025-10-18-a-las-00-25-27-96e5a932.jpg" alt="QR Yape" class="w-48 h-48 rounded-lg shadow-lg border-2 border-indigo-100">
            </div>
            
            <p class="text-sm text-indigo-600 font-semibold mb-6">Yapea al QR</p>

            <div class="flex flex-col gap-3">
                <button onclick="confirmCopy()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition transform hover:scale-105">
                    Ya doné / Copiar Código Ahora
                </button>
                <button onclick="confirmCopy()" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 rounded-xl hover:bg-gray-300 transition text-sm">
                    Solo Copiar (Gratis)
                </button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-50 hidden transition-opacity duration-300">
        <svg class="animate-spin h-16 w-16 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loadingText" class="text-white text-2xl font-bold tracking-widest animate-pulse">Cargando...</p>
        <p id="countdown" class="text-white text-7xl font-bold mt-2"></p>
    </div>

    <script>
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analyzeBtnIcon = document.getElementById('analyzeBtnIcon');
        const analyzeBtnText = document.getElementById('analyzeBtnText');
        const resultsDiv = document.getElementById('results');
        const uploadExcelBtn = document.getElementById('uploadExcelBtn');
        const excelUploadInput = document.getElementById('excelUpload');
        const fileMessageDiv = document.getElementById('fileMessage'); 
        const loadingOverlay = document.getElementById('loadingOverlay');
        const countdownElement = document.getElementById('countdown');
        const loadingText = document.getElementById('loadingText');
        const initialStateDiv = document.getElementById('initialState');
        const donationModal = document.getElementById('donationModal');
        
        // --- Globals ---
        let finalMarkdownContent = "";
        let histogramChartInstance = null; 
        const copyMarkdownContainer = document.getElementById('copyMarkdownContainer');
        const btnCopyMarkdown = document.getElementById('btnCopyMarkdown');

        // --- Constante de Límite ---
        const DATA_LIMIT_FOR_DETAILS = 1000;

        // --- Función para generar datos aleatorios ---
        const generateRandomData = (type = 'decimal', decimals = 2) => {
            const data = [];
            const count = 200;
            const min = 10;
            const max = 100;
            
            if (type === 'qualitative') {
                const categories = ["Bueno", "Regular", "Malo", "Muy Bueno", "Optimo"];
                for (let i = 0; i < count; i++) {
                    data.push(categories[Math.floor(Math.random() * categories.length)]);
                }
            } else { 
                for (let i = 0; i < count; i++) {
                    let randomNumber = Math.random() * (max - min) + min;
                    if (type === 'decimal') { 
                        data.push(randomNumber.toFixed(decimals));
                    } else { 
                        data.push(Math.floor(randomNumber)); 
                    }
                }
            }
            document.getElementById('rawData').value = data.join(', ');
        };

        document.getElementById('loadSampleIntBtn').addEventListener('click', () => generateRandomData('integer'));
        document.getElementById('loadSampleDec2Btn').addEventListener('click', () => generateRandomData('decimal', 2));
        document.getElementById('loadSampleDec4Btn').addEventListener('click', () => generateRandomData('decimal', 4));
        document.getElementById('loadSampleQualBtn').addEventListener('click', () => generateRandomData('qualitative'));

        document.getElementById('clearDataBtn').addEventListener('click', () => {
            document.getElementById('rawData').value = '';
            resultsDiv.innerHTML = '';
            if(initialStateDiv) initialStateDiv.style.display = 'block';
            fileMessageDiv.textContent = '';
            fileMessageDiv.classList.remove('text-red-600', 'text-green-600');
            document.getElementById('variableName').value = '';
            copyMarkdownContainer.style.display = 'none';
            finalMarkdownContent = "";
            if (histogramChartInstance) {
                histogramChartInstance.destroy();
                histogramChartInstance = null;
            }
        });

        uploadExcelBtn.addEventListener('click', () => {
             fileMessageDiv.textContent = '';
             excelUploadInput.click();
        });

        excelUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            loadingText.textContent = 'Procesando Archivo...';
            countdownElement.classList.add('hidden'); 
            loadingOverlay.classList.remove('hidden');
            analyzeBtn.disabled = true; 

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheet];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    const columnData = [];
                    for (let i = 1; i < json.length; i++) {
                        const row = json[i];
                        if (row[0] !== null && row[0] !== undefined) {
                            columnData.push(String(row[0]).trim());
                        }
                    }
                    
                    document.getElementById('rawData').value = columnData.join(', ');
                    fileMessageDiv.textContent = `¡${columnData.length} filas cargadas desde ${file.name}!`;
                    fileMessageDiv.classList.remove('text-red-600');
                    fileMessageDiv.classList.add('text-green-600');

                } catch (error) {
                    console.error("Error al leer el archivo Excel:", error);
                    fileMessageDiv.textContent = 'Error al procesar el archivo. Asegúrese de que sea un .xlsx o .xls válido.';
                    fileMessageDiv.classList.add('text-red-600');
                    fileMessageDiv.classList.remove('text-green-600');
                } finally {
                    loadingOverlay.classList.add('hidden');
                    analyzeBtn.disabled = false; 
                    event.target.value = null; 
                }
            };
            
            reader.onerror = () => {
                 fileMessageDiv.textContent = 'No se pudo leer el archivo.';
                 fileMessageDiv.classList.add('text-red-600');
                 fileMessageDiv.classList.remove('text-green-600');
                 loadingOverlay.classList.add('hidden'); 
                 analyzeBtn.disabled = false; 
            }

            reader.readAsArrayBuffer(file);
        });

        analyzeBtn.addEventListener('click', () => {
            const variableNameInput = document.getElementById('variableName');
            const rawDataInput = document.getElementById('rawData');
            
            const variableName = variableNameInput.value;
            const rawData = rawDataInput.value;
            const histColor = document.getElementById('histColor').value;
            
            resultsDiv.innerHTML = ''; 
            copyMarkdownContainer.style.display = 'none';
            if(initialStateDiv) initialStateDiv.style.display = 'none';
            variableNameInput.classList.remove('border-red-500', 'ring-red-500');
            rawDataInput.classList.remove('border-red-500', 'ring-red-500');
            fileMessageDiv.textContent = ''; 
            fileMessageDiv.classList.remove('text-red-600', 'text-green-600');

            if (variableName.trim() === '') {
                resultsDiv.innerHTML = `<div class="main-card p-6 text-center fade-in error-box"><h3>Error de Validación</h3><p class="mt-2">Por favor, ingrese un nombre para la variable antes de analizar.</p></div>`;
                variableNameInput.classList.add('border-red-500', 'ring-red-500'); 
                variableNameInput.focus();
                return;
            }
            
            const cleanedData = rawData.trim()
                                    .replace(/[\n\t\r;()\[\]:]+/g, ',') 
                                    .replace(/(\s*,\s*)+/g, ',')       
                                    .replace(/\s+/g, ',');             
            
            const dataArray = cleanedData.split(',').filter(n => n.trim() !== ''); 

            if (dataArray.length < 5) {
                resultsDiv.innerHTML = `<div class="main-card p-6 text-center fade-in error-box"><h3>Error de Datos</h3><p class="mt-2">Se necesitan al menos 5 puntos de datos para un análisis significativo.</p></div>`;
                rawDataInput.classList.add('border-red-500', 'ring-red-500');
                rawDataInput.focus();
                return;
            }

            let isNumeric = null;
            let invalidEntries = [];
            const numericData = [];
            const qualitativeData = [];
            const numericRegex = /^-?(\d+(\.\d*)?|\.\d+)$/;

            for (const item of dataArray) {
                const trimmedItem = item.trim();
                const num = Number(trimmedItem);
                
                if (numericRegex.test(trimmedItem) && !isNaN(num)) {
                    if (isNumeric === null) isNumeric = true; 
                    else if (isNumeric === false) invalidEntries.push(trimmedItem); 
                    numericData.push(num);
                } else {
                    if (isNumeric === null) isNumeric = false; 
                    else if (isNumeric === true) invalidEntries.push(trimmedItem); 
                    qualitativeData.push(trimmedItem);
                }
            }

            if (invalidEntries.length > 0) {
                let errorMsg = isNumeric ? "Se esperaban números pero se encontró texto o formatos inválidos" : "Se esperaba texto pero se encontraron números";
                resultsDiv.innerHTML = `<div class="main-card p-6 text-center fade-in error-box">
                    <h3>Error de Datos Mixtos o Formato Inválido</h3>
                    <p class="mt-2">${errorMsg} (ej. <code>24..5</code>, <code>--3</code>, <code>1 2 3.4</code>).</p>
                    <p class="mt-2">Por favor, revise los siguientes datos:</p>
                    <code class="block bg-red-100 p-2 mt-2 rounded">${invalidEntries.slice(0, 10).join(', ')}...</code>
                </div>`;
                rawDataInput.classList.add('border-red-500', 'ring-red-500');
                rawDataInput.focus();
                return;
            }

            analyzeBtn.disabled = true;
            analyzeBtnIcon.classList.add('hidden'); 
            analyzeBtnText.textContent = 'Cargando...'; 
            
            loadingText.textContent = 'Cargando...'; 
            countdownElement.classList.add('hidden'); 
            loadingOverlay.classList.remove('hidden');
            
            setTimeout(() => { 
                try {
                    if (isNumeric) {
                        analisisCuantitativo(numericData, variableName, histColor);
                    } else {
                        analisisCualitativo(qualitativeData, variableName, histColor);
                    }
                    copyMarkdownContainer.style.display = 'block';

                } catch (e) {
                    console.error("Error durante el análisis:", e);
                    resultsDiv.innerHTML = `<div class="main-card p-6 text-center fade-in error-box">
                        <h3>Error Inesperado</h3>
                        <p class="mt-2">Ocurrió un error al procesar los datos. Esto puede suceder con conjuntos de datos extremadamente grandes o complejos.</p>
                        <p class="mt-2"><code>${e.message}</code></p>
                    </div>`;
                } finally {
                    loadingOverlay.classList.add('hidden');
                    analyzeBtn.disabled = false;
                    analyzeBtnIcon.classList.remove('hidden'); 
                    analyzeBtnText.textContent = 'Analizar';
                }
            }, 50); 
        });

        // --- Lógica del Modal ---
        btnCopyMarkdown.addEventListener('click', () => {
            donationModal.classList.add('active');
        });

        function closeModal() {
            donationModal.classList.remove('active');
        }

        function confirmCopy() {
            const btn = document.getElementById('btnCopyMarkdown');
            
            // Lógica para adjuntar imagen base64 al Markdown
            let contentToCopy = finalMarkdownContent;
            
            if (histogramChartInstance) {
                // Generar imagen base64 del gráfico actual
                const imgBase64 = histogramChartInstance.toBase64Image();
                // Añadir imagen al final del markdown
                contentToCopy += `\n\n## Histograma de Frecuencias\n\n![Histograma](${imgBase64})\n`;
            }

            copyToClipboard(contentToCopy, btn);
            closeModal();
        }

        function copyToClipboard(text, button) {
            if (!button) {
                console.warn("copyToClipboard: Button element is null/undefined. Copying text only.");
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus(); textArea.select();
                try {
                    document.execCommand('copy');
                } catch (err) { console.error('Error al copiar texto: ', err); }
                document.body.removeChild(textArea);
                return;
            }
            
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try {
                document.execCommand('copy');
                const originalContent = button.innerHTML;
                button.innerHTML = '¡Copiado!'; 
                button.classList.add('text-emerald-500');
                setTimeout(() => {
                    if (button) {
                        button.innerHTML = originalContent;
                        button.classList.remove('text-emerald-500');
                    }
                }, 2000);
            } catch (err) { console.error('Error al copiar texto: ', err); }
            document.body.removeChild(textArea);
        }
        
        function formatSmart(num, maxDecimals = 10) {
            if (typeof num !== 'number' || isNaN(num) || num === null) return 'N/A';
            let numStr = num.toFixed(maxDecimals);
            if (numStr.indexOf('.') === -1) return numStr;
            numStr = numStr.replace(/(\.\d*?[1-9])0+$/, '$1'); 
            numStr = numStr.replace(/\.0+$/, ''); 
            return numStr; 
        }

        function formatAPDA(num, decimals = 4) {
             if (isNaN(num) || num === null) return 'N/A';
             return num.toFixed(decimals);
        }
        function formatAPDA_F(num, decimals = 2){
             if (isNaN(num) || num === null) return 'N/A';
             return num.toFixed(decimals);
        }

        const createAccordion = (title, resultValue, formula, development, result) => {
            const finalResultValue = (typeof resultValue === 'string') ? resultValue : formatSmart(resultValue, 3);
            
            const rawText = `Cálculo: ${title}\n\nFórmula:\n${formula}\n\nDesarrollo:\n${development.replace(/<div.+?>|<\/div>|<p.+?>|<\/p>/g, '\n').replace(/; ;/g, ';').replace(/\s{2,}/g, ' ').trim()}\n\nResultado:\n${result}`;
            
            let safeText = rawText
                .replace(/\\/g, '\\\\') 
                .replace(/'/g, "\\'")   
                .replace(/\n/g, "\\n")  
                .replace(/"/g, "&quot;");

            const formulaHtml = `<h4>Fórmula <button class="copy-btn" onclick="copyToClipboard('${safeText}', this)" title="Copiar fórmula"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button></h4>${formula}`;
            
            return `<details class="accordion-item"><summary><div class="flex-grow"><span class="font-semibold text-lg text-gray-700">${title}</span></div><span class="font-bold text-lg text-indigo-600">${finalResultValue}</span></summary><div class="accordion-content"><div class="calculation-step">${formulaHtml}</div><div class="calculation-step"><h4>Desarrollo</h4><div class="scrollable-equation">${development}</div></div><div class="calculation-step"><h4>Resultado</h4>${result}</div></div></details>`;
        };

        const createSimpleAccordion = (title, resultValue, resultLatex) => {
            const finalResultValue = (typeof resultValue === 'string') ? resultValue : formatSmart(resultValue, 3);
            
            return `<details class="accordion-item">
                <summary>
                    <div class="flex-grow"><span class="font-semibold text-lg text-gray-700">${title}</span></div>
                    <span class="font-bold text-lg text-indigo-600">${finalResultValue}</span>
                </summary>
                <div class="accordion-content">
                    <div class="calculation-step">
                        <h4>Resultado</h4>
                        ${resultLatex}
                    </div>
                </div>
            </details>`;
        };

        const addToMarkdown = (title, formula, development, result) => {
            return `### ${title}\n\n**Fórmula:**\n${formula}\n\n**Desarrollo:**\n${development}\n\n**Resultado:**\n${result}\n\n---\n\n`;
        };

        const createMarkdownTable = (headers, rows) => {
            let md = "| " + headers.join(" | ") + " |\n";
            md += "| " + headers.map(() => "---").join(" | ") + " |\n";
            rows.forEach(row => {
                md += "| " + row.join(" | ") + " |\n";
            });
            return md + "\n";
        };

        const createSumString = (items, separator = ' + ') => {
            const limit = 50; 
            if (items.length > limit) { 
                return items.slice(0, 25).join(separator) + ' + \\dots + ' + items.slice(-25).join(separator);
            }
            return items.join(separator);
        };

        // --- Función para descargar el gráfico Chart.js ---
        function downloadChart() {
            if (!histogramChartInstance) return;
            const a = document.createElement('a');
            a.href = histogramChartInstance.toBase64Image();
            a.download = 'histograma.png';
            a.click();
        }

        // ==========================================================
        // --- FUNCIÓN DE ANÁLISIS CUANTITATIVO (NÚMEROS) ---
        // ==========================================================
        function analisisCuantitativo(y, nombre_variable, color_hist) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            if (histogramChartInstance) {
                histogramChartInstance.destroy();
                histogramChartInstance = null;
            }

            finalMarkdownContent = `# Análisis Estadístico: ${nombre_variable}\n\n`;
            
            const n_ind = y.length; 
            if (n_ind === 0) return; 
            const vlrmax = Math.max(...y); 
            const vlrmin = Math.min(...y); 
            const rango = vlrmax - vlrmin;
            
            const mean_orig = y.reduce((a, b) => a + b, 0) / n_ind;
            const var_orig = n_ind > 1 ? y.reduce((sum, val) => sum + Math.pow(val - mean_orig, 2), 0) / (n_ind - 1) : 0;
            const sd_orig = Math.sqrt(var_orig);
            const cv_orig = (mean_orig !== 0) ? (sd_orig / mean_orig) * 100 : NaN;
            
            let y_sorted, median_orig, q1_orig, q3_orig, d1_orig, d9_orig;
            
            if (n_ind <= 200000) { 
                y_sorted = [...y].sort((a, b) => a - b);
                const percentile_orig = (p) => {
                    const index = p * (n_ind - 1);
                    const lower_index = Math.floor(index);
                    const upper_index = Math.ceil(index);
                    const fraction = index - lower_index;
                    if (lower_index === upper_index) return y_sorted[lower_index];
                    return y_sorted[lower_index] + (y_sorted[upper_index] - y_sorted[lower_index]) * fraction;
                };
                median_orig = percentile_orig(0.5);
                q1_orig = percentile_orig(0.25);
                q3_orig = percentile_orig(0.75);
                d1_orig = percentile_orig(0.10);
                d9_orig = percentile_orig(0.90);
            } else {
                median_orig = q1_orig = q3_orig = d1_orig = d9_orig = NaN;
            }

            let n_clases, amp, puntos;
            n_clases = Math.round(1 + 3.3 * Math.log10(n_ind));
            if (n_clases <= 0) n_clases = 1;
            amp = (rango === 0) ? 1 : rango / n_clases;
            if (amp === 0) amp = 1;
            puntos = Array.from({ length: n_clases + 1 }, (_, i) => vlrmin + i * amp);
            
            if (n_clases <= 0) {
                 resultsDiv.innerHTML = `<div class="main-card p-6 text-center fade-in"><p class="text-red-600 font-semibold">No se pudieron generar intervalos.</p></div>`;
                 return;
            }

            let LimInf = [], LimSup = [], Xi = [], fabs = Array(n_clases).fill(0);
            
            const tolerance = 1e-9 * amp; 
            for (const val of y) {
                 let found = false;
                 for (let i = 0; i < n_clases; i++) {
                    const isLastClass = (i === n_clases - 1);
                    const checkLower = val >= puntos[i] - tolerance;
                    const checkUpper = isLastClass ? val <= puntos[i+1] + tolerance : val < puntos[i+1] - tolerance;
                    if (checkLower && checkUpper) {
                        fabs[i]++;
                        found = true;
                        break; 
                    }
                }
                 if (!found && Math.abs(val - vlrmax) < 1e-9) {
                    fabs[n_clases - 1]++;
                 }
            }
            
            for (let i = 0; i < n_clases; i++) {
                 LimInf[i] = puntos[i]; LimSup[i] = puntos[i+1]; Xi[i] = (puntos[i] + puntos[i+1]) / 2;
            }
            
            const fabsacum = fabs.reduce((acc, val, i) => [...acc, (acc[i-1] || 0) + val], []);
            const frel = fabs.map(f => f / n_ind); const frelPor = frel.map(h => h * 100);
            const frelacum = frel.reduce((acc, val, i) => [...acc, (acc[i-1] || 0) + val], []); const frelacumPor = frelacum.map(h => h * 100);
            const P_Mues = Xi.reduce((sum, val, i) => sum + val * fabs[i], 0) / n_ind;
            const n_medios = n_ind / 2; const w = fabsacum.findIndex(f => f >= n_medios - 1e-9); 
            const F_anterior_med = (w === 0) ? 0 : fabsacum[w-1];
            const Me_Mues = (w === -1 || fabs[w] === 0) ? NaN : LimInf[w] + (((n_medios - F_anterior_med) / fabs[w]) * amp);
            const u = fabs.indexOf(Math.max(...fabs)); const d1_moda = fabs[u] - (fabs[u-1] || 0); const d2_moda = fabs[u] - (fabs[u+1] || 0);
            const Mo_Mues = (d1_moda + d2_moda === 0 || u === -1) ? NaN : LimInf[u] + (d1_moda / (d1_moda + d2_moda)) * amp; 
            const valid_xi_gt_0 = Xi.filter((x,i) => fabs[i] > 0 && x > 0);
            const valid_fabs_gt_0 = fabs.filter((f,i) => f > 0 && Xi[i] > 0);
            const sum_log = valid_xi_gt_0.reduce((sum, val, i) => sum + valid_fabs_gt_0[i] * Math.log10(val), 0); 
            const count_gt_0 = valid_fabs_gt_0.reduce((s,f) => s+f, 0);
            const Me_Geo = count_gt_0 > 0 ? Math.pow(10, sum_log / count_gt_0) : NaN;
            const valid_xi_ne_0 = Xi.filter((x,i) => fabs[i] > 0 && x !== 0);
            const valid_fabs_ne_0 = fabs.filter((f,i) => f > 0 && Xi[i] !== 0);
            const sum_inv = valid_xi_ne_0.reduce((sum, val, i) => sum + valid_fabs_ne_0[i] / val, 0); 
            const count_ne_0 = valid_fabs_ne_0.reduce((s,f) => s+f, 0);
            const Me_Arm = (count_ne_0 > 0 && sum_inv !== 0) ? count_ne_0 / sum_inv : NaN;
            const sum_sq_diff = Xi.reduce((sum, val, i) => sum + Math.pow(val - P_Mues, 2) * fabs[i], 0); 
            const Va_Mues = n_ind > 1 ? sum_sq_diff / (n_ind - 1) : 0; 
            const Des_Est = Math.sqrt(Va_Mues); 
            const Cof_Var = (P_Mues !== 0) ? (Des_Est / P_Mues) * 100 : NaN; 
            const calcular_cuantil = (k, q) => { const pos = (k * n_ind) / q; const clase = fabsacum.findIndex(f => f >= pos - 1e-9); if (clase === -1 || fabs[clase] === 0) return { cuantil: NaN, Li: (clase === -1 ? NaN : LimInf[clase]), pos, Fi_ant: (clase === -1 ? NaN : (clase === 0 ? 0 : fabsacum[clase-1])), fi: (clase === -1 ? NaN : fabs[clase])}; const F_ant = (clase === 0) ? 0 : fabsacum[clase - 1]; return { cuantil: LimInf[clase] + (((pos - F_ant) / fabs[clase]) * amp), Li: LimInf[clase], pos, Fi_ant: F_ant, fi: fabs[clase]}; };
            const q1_calc = calcular_cuantil(1, 4); const q3_calc = calcular_cuantil(3, 4); 
            const d1_calc = calcular_cuantil(1, 10); const d9_calc = calcular_cuantil(9, 10);
            const asimetria = (Des_Est !== 0 && !isNaN(Mo_Mues)) ? (P_Mues - Mo_Mues) / Des_Est : NaN; 
            const sum_pow4_diff = Xi.reduce((sum, val, i) => sum + fabs[i] * Math.pow(val - P_Mues, 4), 0); 
            const m4 = sum_pow4_diff / n_ind;
            const curtosis = (Des_Est !== 0 && Des_Est > 1e-9) ? m4 / Math.pow(Des_Est, 4) - 3 : NaN; 

            // --- GENERACIÓN DE HTML ---
            let directStatsHTML = ``;
            if(n_ind <= DATA_LIMIT_FOR_DETAILS) {
                directStatsHTML += `<div class="main-card p-6 fade-in"><h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Análisis de Datos Originales (No Agrupados)</h2><div class="space-y-4">`;
                const dev_mean_orig = `$$\\bar{x} = \\frac{${createSumString(y.map(v => formatSmart(v, 10)))}}{${n_ind}}$$ <p class="whitespace-normal mt-4">$$\\bar{x} = \\frac{${formatSmart(mean_orig * n_ind, 10)}}{${n_ind}}$$</p>`;
                const dev_var_orig = `$$S^2 = \\frac{${createSumString(y.map(v => `(${formatSmart(v, 10)} - ${formatSmart(mean_orig, 10)})^2`))}}{${n_ind - 1}}$$ <p class="whitespace-normal mt-4">$$S^2 = \\frac{${formatSmart(var_orig * (n_ind - 1), 10)}}{${n_ind - 1}}$$</p>`;
                
                directStatsHTML += createAccordion('Media (No Agrupada)', mean_orig, '$$\\bar{x} = \\frac{\\sum x_i}{n}$$', dev_mean_orig, `$$\\bar{x} = ${formatSmart(mean_orig, 10)}$$`);
                directStatsHTML += createAccordion('Mediana (No Agrupada)', median_orig, '$$Me = Valor \\; en \\; pos \\; 0.5(n+1)$$', `<p class="whitespace-normal">$$Me = Valor \\; en \\; pos \\; ${formatSmart(0.5*(n_ind+1), 1)}$$</p><p class="whitespace-normal mt-2">Se interpola entre los valores de la lista ordenada.</p>`, `$$Me = ${formatSmart(median_orig, 10)}$$`);
                directStatsHTML += createAccordion('Varianza (No Agrupada)', var_orig, '$$S^2 = \\frac{\\sum (x_i - \\bar{x})^2}{n-1}$$', dev_var_orig, `$$S^2 = ${formatSmart(var_orig, 10)}$$`);
                directStatsHTML += createAccordion('Desv. Estándar (No Agrupada)', sd_orig, '$$S = \\sqrt{S^2}$$', `<p class="whitespace-normal">$$S = \\sqrt{${formatSmart(var_orig, 10)}}$$</p>`, `$$S = ${formatSmart(sd_orig, 10)}$$`);
                directStatsHTML += createAccordion('Coef. de Variación (No Agrupado)', `${formatSmart(cv_orig, 3)} %`, '$$CV = \\frac{S}{\\bar{x}} \\cdot 100\\%$$', `<p class="whitespace-normal">$$CV = \\frac{${formatSmart(sd_orig, 10)}}{${formatSmart(mean_orig, 10)}} \\cdot 100\\%$$`, `$$CV = ${formatSmart(cv_orig, 10)}\\%$$`);
                directStatsHTML += `</div></div>`;

                finalMarkdownContent += `## 1. Datos No Agrupados\n\n`;
                finalMarkdownContent += addToMarkdown('Media (No Agrupada)', `$$\\bar{x} = \\frac{\\sum x_i}{n}$$`, `$$\\bar{x} = \\frac{${createSumString(y.map(v => formatSmart(v, 10)))}}{${n_ind}}$$\n\n$$\\bar{x} = \\frac{${formatSmart(mean_orig * n_ind, 10)}}{${n_ind}}$$`, `$$\\bar{x} = ${formatSmart(mean_orig, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Mediana (No Agrupada)', `$$Me = Valor \\; en \\; pos \\; 0.5(n+1)$$`, `$$Me = Valor \\; en \\; pos \\; ${formatSmart(0.5*(n_ind+1), 1)}$$\n\nSe interpola entre los valores de la lista ordenada.`, `$$Me = ${formatSmart(median_orig, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Varianza (No Agrupada)', `$$S^2 = \\frac{\\sum (x_i - \\bar{x})^2}{n-1}$$`, `$$S^2 = \\frac{${createSumString(y.map(v => `(${formatSmart(v, 10)} - ${formatSmart(mean_orig, 10)})^2`))}}{${n_ind - 1}}$$\n\n$$S^2 = \\frac{${formatSmart(var_orig * (n_ind - 1), 10)}}{${n_ind - 1}}$$`, `$$S^2 = ${formatSmart(var_orig, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Desv. Estándar (No Agrupada)', `$$S = \\sqrt{S^2}$$`, `$$S = \\sqrt{${formatSmart(var_orig, 10)}}$$`, `$$S = ${formatSmart(sd_orig, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Coef. de Variación (No Agrupado)', `$$CV = \\frac{S}{\\bar{x}} \\cdot 100\\%$$`, `$$CV = \\frac{${formatSmart(sd_orig, 10)}}{${formatSmart(mean_orig, 10)}} \\cdot 100\\%$$`, `$$CV = ${formatSmart(cv_orig, 10)}\\%$$`);

            } else {
                directStatsHTML += `<div class="main-card p-6 fade-in"><h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Análisis de Datos Originales (No Agrupados)</h2><div class="space-y-4">`;
                directStatsHTML += createSimpleAccordion('Media (No Agrupada)', mean_orig, `$$\\bar{x} = ${formatSmart(mean_orig, 10)}$$`);
                directStatsHTML += createSimpleAccordion('Mediana (No Agrupada)', median_orig, isNaN(median_orig) ? 'N/A' : `$$Me = ${formatSmart(median_orig, 10)}$$`);
                directStatsHTML += createSimpleAccordion('Varianza (No Agrupada)', var_orig, `$$S^2 = ${formatSmart(var_orig, 10)}$$`);
                directStatsHTML += createSimpleAccordion('Desv. Estándar (No Agrupada)', sd_orig, `$$S = ${formatSmart(sd_orig, 10)}$$`);
                directStatsHTML += createSimpleAccordion('Coef. de Variación (No Agrupado)', `${formatSmart(cv_orig, 3)} %`, `$$CV = ${formatSmart(cv_orig, 10)}\\%$$`);
                directStatsHTML += `</div></div>`;
                
                finalMarkdownContent += `## 1. Datos No Agrupados\n\n`;
                finalMarkdownContent += `- **Media:** ${formatSmart(mean_orig, 10)}\n`;
                finalMarkdownContent += `- **Mediana:** ${isNaN(median_orig) ? 'N/A' : formatSmart(median_orig, 10)}\n`;
                finalMarkdownContent += `- **Varianza:** ${formatSmart(var_orig, 10)}\n`;
                finalMarkdownContent += `- **Desv. Estándar:** ${formatSmart(sd_orig, 10)}\n`;
                finalMarkdownContent += `- **Coef. Variación:** ${formatSmart(cv_orig, 10)}%\n\n`;
            }

            // --- 2. Tarjeta de Análisis Agrupado ---
            let groupedHTML = `<div class="main-card p-6 fade-in"><h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>Análisis de Datos Agrupados (Método APDA Clásico)</h2>`;
            
            // 2.1 Tabla HTML
            groupedHTML += `<h3 class="text-xl font-semibold text-gray-700 mb-3 mt-4">2.1. Tabla de Frecuencias</h3><div class="overflow-x-auto"><table class="result-table w-full"><thead><tr><th>[ Li</th><th> Ls ></th><th> xi</th><th>F.A</th><th>F.A.A</th><th>F.R</th><th>F.R.A</th><th>F.R.%</th></tr></thead><tbody>`;
            for (let i = 0; i < n_clases; i++) { groupedHTML += `<tr><td>${formatAPDA(LimInf[i], 4)}</td><td>${formatAPDA(LimSup[i], 4)}</td><td>${formatAPDA(Xi[i], 4)}</td><td>${fabs[i]}</td><td>${fabsacum[i]}</td><td>${formatAPDA_F(frel[i], 2)}</td><td>${formatAPDA_F(frelacum[i], 2)}</td><td>${Math.round(frelPor[i])}</td></tr>`; }
            groupedHTML += `</tbody></table></div>`;

            finalMarkdownContent += `## 2.1. Tabla de Frecuencias\n\n`;
            const mdTableHeaders = ["Li", "Ls", "xi", "F.A", "F.A.A", "F.R", "F.R.A", "F.R.%"];
            const mdTableRows = [];
            for (let i = 0; i < n_clases; i++) {
                mdTableRows.push([formatAPDA(LimInf[i]), formatAPDA(LimSup[i]), formatAPDA(Xi[i]), fabs[i], fabsacum[i], formatAPDA_F(frel[i]), formatAPDA_F(frelacum[i]), Math.round(frelPor[i]) + "%"]);
            }
            finalMarkdownContent += createMarkdownTable(mdTableHeaders, mdTableRows);

            // 2.2 Histograma Chart.js
            groupedHTML += `<h3 class="text-xl font-semibold text-gray-700 mb-3 mt-8 flex justify-between items-center">
                2.2. Histograma de Frecuencias
                <button onclick="downloadChart()" class="text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-1 rounded transition">Descargar Gráfico</button>
            </h3>
            <div class="chart-container">
                <canvas id="histogramChart"></canvas>
            </div>`;

            // 2.3 Cálculo Detallado HTML & MD
            groupedHTML += `<h3 class="text-xl font-semibold text-gray-700 mb-3 mt-8">2.3. Cálculo Detallado (Datos Agrupados)</h3>`;
            
            if(n_ind <= DATA_LIMIT_FOR_DETAILS) {
                finalMarkdownContent += `## 2.3. Cálculo Detallado (Datos Agrupados)\n\n`; 
                groupedHTML += `<div class="space-y-4">`;
                const dev_P_Mues = `$$\\bar{x} = \\frac{${createSumString(Xi.map((xi, i) => `(${formatSmart(xi)} \\cdot ${fabs[i]})`))}}{${n_ind}}$$ <p class="whitespace-normal mt-4">$$\\bar{x} = \\frac{${formatSmart(P_Mues*n_ind)}}{${n_ind}}$$</p>`;
                const dev_Me_Mues = `<p class="whitespace-normal">$$Me = ${formatSmart(LimInf[w])} + \\left( \\frac{\\frac{${n_ind}}{2} - ${F_anterior_med}}{${fabs[w]}} \\right) \\cdot ${formatSmart(amp)} = ${formatSmart(LimInf[w])} + \\left( \\frac{${n_medios} - ${F_anterior_med}}{${fabs[w]}} \\right) \\cdot ${formatSmart(amp)}$$</p>`;
                const dev_Mo_Mues = `<p class="whitespace-normal">$$d_1 = ${fabs[u]} - ${fabs[u-1] || 0} = ${d1_moda} ; \\; d_2 = ${fabs[u]} - ${fabs[u+1] || 0} = ${d2_moda}$$</p> <p class="whitespace-normal mt-4">$$Mo = ${formatSmart(LimInf[u])} + \\left( \\frac{${d1_moda}}{${d1_moda} + ${d2_moda}} \\right) \\cdot ${formatSmart(amp)}$$</p>`;
                const dev_Me_Geo = `$$Xg = \\text{antilog} \\left( \\frac{${createSumString(Xi.map((xi, i) => `(${fabs[i]} \\cdot \\log_{10}(${formatSmart(xi)}))`))}}{${n_ind}} \\right)$$ <p class="whitespace-normal mt-4">$$Xg = \\text{antilog} \\left( \\frac{${formatSmart(sum_log)}}{${n_ind}} \\right)$$</p>`;
                const dev_Me_Arm = `$$Xh = \\frac{${n_ind}}{${createSumString(Xi.map((xi, i) => `\\frac{${fabs[i]}}{${formatSmart(xi)}}`))}}$$ <p class="whitespace-normal mt-4">$$Xh = \\frac{${n_ind}}{${formatSmart(sum_inv)}}$$</p>`;
                const dev_Va_Mues = `$$S^2 = \\frac{${createSumString(Xi.map((xi, i) => `(${formatSmart(xi)} - ${formatSmart(P_Mues)})^2 \\cdot ${fabs[i]}`))}}{${n_ind-1}}$$ <p class="whitespace-normal mt-4">$$S^2 = \\frac{${formatSmart(sum_sq_diff)}}{${n_ind-1}}$$</p>`;
                const dev_Curtosis = `$$g_2 = \\frac{${createSumString(Xi.map((xi, i) => `${fabs[i]} \\cdot (${formatSmart(xi)} - ${formatSmart(P_Mues)})^4`), ' + ')}}{${n_ind} \\cdot {(${formatSmart(Des_Est)})}^4} - 3$$ <p class="whitespace-normal mt-4">$$g_2 = \\frac{${formatSmart(m4)}}{{(${formatSmart(Des_Est)})}^4} - 3$$</p>`;

                groupedHTML += createAccordion('Media Aritmética (Agrupada)', P_Mues, '$$\\bar{x} = \\frac{\\sum (x_i \\cdot f_i)}{n}$$', dev_P_Mues, `$$\\bar{x} = ${formatSmart(P_Mues, 10)}$$`);
                groupedHTML += createAccordion('Mediana (Agrupada)', Me_Mues, '$$Me = L_i + \\left( \\frac{\\frac{n}{2} - F_{i-1}}{f_i} \\right) \\cdot C$$', dev_Me_Mues, `$$Me = ${formatSmart(Me_Mues, 10)}$$`);
                groupedHTML += createAccordion('Moda (Agrupada)', Mo_Mues, '$$Mo = L_i + \\left( \\frac{d_1}{d_1 + d_2} \\right) \\cdot C$$', dev_Mo_Mues, `$$Mo = ${formatSmart(Mo_Mues, 10)}$$`);
                groupedHTML += createAccordion('Media Geométrica (Agrupada)', Me_Geo, '$$Xg = \\text{antilog} \\left( \\frac{\\sum (f_i \\cdot \\log_{10}(x_i))}{n} \\right)$$', dev_Me_Geo, `$$Xg = ${formatSmart(Me_Geo, 10)}$$`);
                groupedHTML += createAccordion('Media Armónica (Agrupada)', Me_Arm, '$$Xh = \\frac{n}{\\sum \\frac{f_i}{x_i}}$$', dev_Me_Arm, `$$Xh = ${formatSmart(Me_Arm, 10)}$$`);
                groupedHTML += createAccordion('Varianza (Agrupada)', Va_Mues, '$$S^2 = \\frac{\\sum (x_i - \\bar{x})^2 \\cdot f_i}{n-1}$$', dev_Va_Mues, `$$S^2 = ${formatSmart(Va_Mues, 10)}$$`);
                groupedHTML += createAccordion('Desviación Estándar (Agrupada)', Des_Est, '$$S = \\sqrt{S^2}$$', `<p class="whitespace-normal">$$S = \\sqrt{${formatSmart(Va_Mues, 10)}}$$</p>`, `$$S = ${formatSmart(Des_Est, 10)}$$`);
                groupedHTML += createAccordion('Coeficiente de Variación (Agrupado)', `${formatSmart(Cof_Var, 3)} %`, '$$CV = \\frac{S}{\\bar{x}} \\cdot 100\\%$$', `<p class="whitespace-normal">$$CV = \\frac{${formatSmart(Des_Est, 10)}}{${formatSmart(P_Mues, 10)}} \\cdot 100\\%$$`, `$$CV = ${formatSmart(Cof_Var, 10)}\\%$$`);
                groupedHTML += createAccordion('Cuartil 1 (Q1)', q1_calc.cuantil, '$$Q_1 = L_i + \\left( \\frac{\\frac{1 \\cdot n}{4} - F_{i-1}}{f_i} \\right) \\cdot C$$', `<p class="whitespace-normal">$$Q_1 = ${formatSmart(q1_calc.Li, 5)} + \\left( \\frac{${formatSmart(q1_calc.pos, 2)} - ${q1_calc.Fi_ant}}{${q1_calc.fi}} \\right) \\cdot ${formatSmart(amp, 5)}$$</p>`, `$$Q_1 = ${formatSmart(q1_calc.cuantil, 10)}$$`);
                groupedHTML += createAccordion('Cuartil 3 (Q3)', q3_calc.cuantil, '$$Q_3 = L_i + \\left( \\frac{\\frac{3 \\cdot n}{4} - F_{i-1}}{f_i} \\right) \\cdot C$$', `<p class="whitespace-normal">$$Q_3 = ${formatSmart(q3_calc.Li, 5)} + \\left( \\frac{${formatSmart(q3_calc.pos, 2)} - ${q3_calc.Fi_ant}}{${q3_calc.fi}} \\right) \\cdot ${formatSmart(amp, 5)}$$</p>`, `$$Q_3 = ${formatSmart(q3_calc.cuantil, 10)}$$`);
                groupedHTML += createAccordion('Decil 1 (D1)', d1_calc.cuantil, '$$D_1 = L_i + \\left( \\frac{\\frac{1 \\cdot n}{10} - F_{i-1}}{f_i} \\right) \\cdot C$$', `<p class="whitespace-normal">$$D_1 = ${formatSmart(d1_calc.Li, 5)} + \\left( \\frac{${formatSmart(d1_calc.pos, 2)} - ${d1_calc.Fi_ant}}{${d1_calc.fi}} \\right) \\cdot ${formatSmart(amp, 5)}$$</p>`, `$$D_1 = ${formatSmart(d1_calc.cuantil, 10)}$$`);
                groupedHTML += createAccordion('Decil 9 (D9)', d9_calc.cuantil, '$$D_9 = L_i + \\left( \\frac{\\frac{9 \\cdot n}{10} - F_{i-1}}{f_i} \\right) \\cdot C$$', `<p class="whitespace-normal">$$D_9 = ${formatSmart(d9_calc.Li, 5)} + \\left( \\frac{${formatSmart(d9_calc.pos, 2)} - ${d9_calc.Fi_ant}}{${d9_calc.fi}} \\right) \\cdot ${formatSmart(amp, 5)}$$</p>`, `$$D_9 = ${formatSmart(d9_calc.cuantil, 10)}$$`);
                groupedHTML += createAccordion('Asimetría (Pearson)', asimetria, '$$As = \\frac{\\bar{x} - Mo}{S}$$', `<p class="whitespace-normal">$$As = \\frac{${formatSmart(P_Mues, 5)} - ${formatSmart(Mo_Mues, 5)}}{${formatSmart(Des_Est, 5)}}$$</p>`, `$$As = ${formatSmart(asimetria, 10)}$$`);
                groupedHTML += createAccordion('Curtosis (Exceso)', curtosis, '$$g_2 = \\frac{\\sum f_i (x_i - \\bar{x})^4}{n \\cdot S^4} - 3$$', dev_Curtosis, `$$g_2 = ${formatSmart(curtosis, 10)}$$`);
                groupedHTML += `</div>`;

                // Aquí corregí las barras invertidas extra en CV, Q y D
                finalMarkdownContent += addToMarkdown('Media Aritmética (Agrupada)', '$$\\bar{x} = \\frac{\\sum (x_i \\cdot f_i)}{n}$$', `$$\\bar{x} = \\frac{${createSumString(Xi.map((xi, i) => `(${formatSmart(xi)} \\cdot ${fabs[i]})`))}}{${n_ind}}$$\n\n$$\\bar{x} = \\frac{${formatSmart(P_Mues*n_ind)}}{${n_ind}}$$`, `$$\\bar{x} = ${formatSmart(P_Mues, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Mediana (Agrupada)', '$$Me = L_i + \\left( \\frac{\\frac{n}{2} - F_{i-1}}{f_i} \\right) \\cdot C$$', `$$Me = ${formatSmart(LimInf[w])} + \\left( \\frac{\\frac{${n_ind}}{2} - ${F_anterior_med}}{${fabs[w]}} \\right) \\cdot ${formatSmart(amp)} = ${formatSmart(LimInf[w])} + \\left( \\frac{${n_medios} - ${F_anterior_med}}{${fabs[w]}} \\right) \\cdot ${formatSmart(amp)}$$`, `$$Me = ${formatSmart(Me_Mues, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Moda (Agrupada)', '$$Mo = L_i + \\left( \\frac{d_1}{d_1 + d_2} \\right) \\cdot C$$', `$$d_1 = ${fabs[u]} - ${fabs[u-1] || 0} = ${d1_moda} ; \\; d_2 = ${fabs[u]} - ${fabs[u+1] || 0} = ${d2_moda}$$\n\n$$Mo = ${formatSmart(LimInf[u])} + \\left( \\frac{${d1_moda}}{${d1_moda} + ${d2_moda}} \\right) \\cdot ${formatSmart(amp)}$$`, `$$Mo = ${formatSmart(Mo_Mues, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Media Geométrica (Agrupada)', '$$Xg = \\text{antilog} \\left( \\frac{\\sum (f_i \\cdot \\log_{10}(x_i))}{n} \\right)$$', `$$Xg = \\text{antilog} \\left( \\frac{${createSumString(Xi.map((xi, i) => `(${fabs[i]} \\cdot \\log_{10}(${formatSmart(xi)}))`))}}{${n_ind}} \\right)$$\n\n$$Xg = \\text{antilog} \\left( \\frac{${formatSmart(sum_log)}}{${n_ind}} \\right)$$`, `$$Xg = ${formatSmart(Me_Geo, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Media Armónica (Agrupada)', '$$Xh = \\frac{n}{\\sum \\frac{f_i}{x_i}}$$', `$$Xh = \\frac{${n_ind}}{${createSumString(Xi.map((xi, i) => `\\frac{${fabs[i]}}{${formatSmart(xi)}}`))}}$$\n\n$$Xh = \\frac{${n_ind}}{${formatSmart(sum_inv)}}$$`, `$$Xh = ${formatSmart(Me_Arm, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Varianza (Agrupada)', '$$S^2 = \\frac{\\sum (x_i - \\bar{x})^2 \\cdot f_i}{n-1}$$', `$$S^2 = \\frac{${createSumString(Xi.map((xi, i) => `(${formatSmart(xi)} - ${formatSmart(P_Mues)})^2 \\cdot ${fabs[i]}`))}}{${n_ind-1}}$$\n\n$$S^2 = \\frac{${formatSmart(sum_sq_diff)}}{${n_ind-1}}$$`, `$$\\S^2 = ${formatSmart(Va_Mues, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Desviación Estándar (Agrupada)', '$$S = \\sqrt{S^2}$$', `$$S = \\sqrt{${formatSmart(Va_Mues, 10)}}$$`, `$$\\S = ${formatSmart(Des_Est, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Coeficiente de Variación (Agrupado)', '$$CV = \\frac{S}{\\bar{x}} \\cdot 100\\%$$', `$$CV = \\frac{${formatSmart(Des_Est, 10)}}{${formatSmart(P_Mues, 10)}} \\cdot 100\\%$$`, `$$CV = ${formatSmart(Cof_Var, 10)}\\%$$`);
                
                finalMarkdownContent += addToMarkdown('Cuartil 1 (Q1)', '$$Q_1 = L_i + \\left( \\frac{\\frac{1 \\cdot n}{4} - F_{i-1}}{f_i} \\right) \\cdot C$$', `$$Q_1 = ${formatSmart(q1_calc.Li, 5)} + \\left( \\frac{${formatSmart(q1_calc.pos, 2)} - ${q1_calc.Fi_ant}}{${q1_calc.fi}} \\right) \\cdot ${formatSmart(amp, 5)}$$`, `$$Q_1 = ${formatSmart(q1_calc.cuantil, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Cuartil 3 (Q3)', '$$Q_3 = L_i + \\left( \\frac{\\frac{3 \\cdot n}{4} - F_{i-1}}{f_i} \\right) \\cdot C$$', `$$Q_3 = ${formatSmart(q3_calc.Li, 5)} + \\left( \\frac{${formatSmart(q3_calc.pos, 2)} - ${q3_calc.Fi_ant}}{${q3_calc.fi}} \\right) \\cdot ${formatSmart(amp, 5)}$$`, `$$Q_3 = ${formatSmart(q3_calc.cuantil, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Decil 1 (D1)', '$$D_1 = L_i + \\left( \\frac{\\frac{1 \\cdot n}{10} - F_{i-1}}{f_i} \\right) \\cdot C$$', `$$D_1 = ${formatSmart(d1_calc.Li, 5)} + \\left( \\frac{${formatSmart(d1_calc.pos, 2)} - ${d1_calc.Fi_ant}}{${d1_calc.fi}} \\right) \\cdot ${formatSmart(amp, 5)}$$`, `$$D_1 = ${formatSmart(d1_calc.cuantil, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Decil 9 (D9)', '$$D_9 = L_i + \\left( \\frac{\\frac{9 \\cdot n}{10} - F_{i-1}}{f_i} \\right) \\cdot C$$', `$$D_9 = ${formatSmart(d9_calc.Li, 5)} + \\left( \\frac{${formatSmart(d9_calc.pos, 2)} - ${d9_calc.Fi_ant}}{${d9_calc.fi}} \\right) \\cdot ${formatSmart(amp, 5)}$$`, `$$D_9 = ${formatSmart(d9_calc.cuantil, 10)}$$`);
                
                finalMarkdownContent += addToMarkdown('Asimetría (Pearson)', '$$As = \\frac{\\bar{x} - Mo}{S}$$', `$$As = \\frac{${formatSmart(P_Mues, 5)} - ${formatSmart(Mo_Mues, 5)}}{${formatSmart(Des_Est, 5)}}$$`, `$$As = ${formatSmart(asimetria, 10)}$$`);
                finalMarkdownContent += addToMarkdown('Curtosis (Exceso)', '$$g_2 = \\frac{\\sum f_i (x_i - \\bar{x})^4}{n \\cdot S^4} - 3$$', `$$g_2 = \\frac{${createSumString(Xi.map((xi, i) => `${fabs[i]} \\cdot (${formatSmart(xi)} - ${formatSmart(P_Mues)})^4`), ' + ')}}{${n_ind} \\cdot {(${formatSmart(Des_Est)})}^4} - 3$$\n\n$$g_2 = \\frac{${formatSmart(m4)}}{{(${formatSmart(Des_Est)})}^4} - 3$$`, `$$g_2 = ${formatSmart(curtosis, 10)}$$`);

            } else {
                groupedHTML += `<div class="space-y-4">`;
                groupedHTML += createSimpleAccordion('Media Aritmética (Agrupada)', P_Mues, `$$\\bar{x} = ${formatSmart(P_Mues, 10)}$$`);
                groupedHTML += createSimpleAccordion('Mediana (Agrupada)', Me_Mues, `$$Me = ${formatSmart(Me_Mues, 10)}$$`);
                groupedHTML += createSimpleAccordion('Moda (Agrupada)', Mo_Mues, `$$Mo = ${formatSmart(Mo_Mues, 10)}$$`);
                groupedHTML += createSimpleAccordion('Media Geométrica (Agrupada)', Me_Geo, `$$Xg = ${formatSmart(Me_Geo, 10)}$$`);
                groupedHTML += createSimpleAccordion('Media Armónica (Agrupada)', Me_Arm, `$$Xh = ${formatSmart(Me_Arm, 10)}$$`);
                groupedHTML += createSimpleAccordion('Varianza (Agrupada)', Va_Mues, `$$S^2 = ${formatSmart(Va_Mues, 10)}$$`);
                groupedHTML += createSimpleAccordion('Desviación Estándar (Agrupada)', Des_Est, `$$S = ${formatSmart(Des_Est, 10)}$$`);
                groupedHTML += createSimpleAccordion('Coeficiente de Variación (Agrupado)', `${formatSmart(Cof_Var, 3)} %`, `$$CV = ${formatSmart(Cof_Var, 10)}\\%$$`);
                groupedHTML += createSimpleAccordion('Cuartil 1 (Q1)', q1_calc.cuantil, `$$Q_1 = ${formatSmart(q1_calc.cuantil, 10)}$$`);
                groupedHTML += createSimpleAccordion('Cuartil 3 (Q3)', q3_calc.cuantil, `$$Q_3 = ${formatSmart(q3_calc.cuantil, 10)}$$`);
                groupedHTML += createSimpleAccordion('Decil 1 (D1)', d1_calc.cuantil, `$$D_1 = ${formatSmart(d1_calc.cuantil, 10)}$$`);
                groupedHTML += createSimpleAccordion('Decil 9 (D9)', d9_calc.cuantil, `$$D_9 = ${formatSmart(d9_calc.cuantil, 10)}$$`);
                groupedHTML += createSimpleAccordion('Asimetría (Pearson)', asimetria, `$$As = ${formatSmart(asimetria, 10)}$$`);
                groupedHTML += createSimpleAccordion('Curtosis (Exceso)', curtosis, `$$g_2 = ${formatSmart(curtosis, 10)}$$`);
                groupedHTML += `</div>`;

                finalMarkdownContent += `## 2.3. Resumen de Cálculos (Datos Agrupados)\n\n`;
                finalMarkdownContent += `- **Media Aritmética:** ${formatSmart(P_Mues, 10)}\n`;
                finalMarkdownContent += `- **Mediana:** ${formatSmart(Me_Mues, 10)}\n`;
                finalMarkdownContent += `- **Moda:** ${formatSmart(Mo_Mues, 10)}\n`;
                finalMarkdownContent += `- **Media Geométrica:** ${formatSmart(Me_Geo, 10)}\n`;
                finalMarkdownContent += `- **Media Armónica:** ${formatSmart(Me_Arm, 10)}\n`;
                finalMarkdownContent += `- **Varianza:** ${formatSmart(Va_Mues, 10)}\n`;
                finalMarkdownContent += `- **Desviación Estándar:** ${formatSmart(Des_Est, 10)}\n`;
                finalMarkdownContent += `- **Coef. Variación:** ${formatSmart(Cof_Var, 10)}%\n`;
                finalMarkdownContent += `- **Cuartil 1 (Q1):** ${formatSmart(q1_calc.cuantil, 10)}\n`;
                finalMarkdownContent += `- **Cuartil 3 (Q3):** ${formatSmart(q3_calc.cuantil, 10)}\n`;
                finalMarkdownContent += `- **Decil 1 (D1):** ${formatSmart(d1_calc.cuantil, 10)}\n`;
                finalMarkdownContent += `- **Decil 9 (D9):** ${formatSmart(d9_calc.cuantil, 10)}\n`;
                finalMarkdownContent += `- **Asimetría (Pearson):** ${formatSmart(asimetria, 10)}\n`;
                finalMarkdownContent += `- **Curtosis (Exceso):** ${formatSmart(curtosis, 10)}\n\n`;
            }
            groupedHTML += `</div>`; 
            
            resultsDiv.innerHTML = directStatsHTML + groupedHTML;
            MathJax.typeset();

            // --- RENDERIZADO DEL CHART.JS DESPUÉS DE INSERTAR EL HTML ---
            const ctx = document.getElementById('histogramChart').getContext('2d');
            
            // Datos para el gráfico
            const labels = Xi.map(val => formatSmart(val, 2));
            const dataFabs = fabs;
            
            const posMedia = (P_Mues - LimInf[0]) / amp - 0.5;
            const posMediana = (Me_Mues - LimInf[0]) / amp - 0.5;

            // Configuración de Chart.js
            histogramChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'line',
                            label: 'Curva de Densidad',
                            data: dataFabs,
                            borderColor: '#059669', // Verde oscuro para la línea
                            backgroundColor: 'transparent',
                            tension: 0.4, // Suavizado de curva
                            pointRadius: 0,
                            borderWidth: 2,
                            order: 1
                        },
                        {
                            type: 'bar',
                            label: 'Frecuencia Absoluta',
                            data: dataFabs,
                            backgroundColor: color_hist,
                            borderColor: 'white',
                            borderWidth: 1,
                            barPercentage: 1.0, // Barras pegadas
                            categoryPercentage: 1.0,
                            order: 2,
                            datalabels: {
                                align: 'end',
                                anchor: 'end',
                                color: '#374151',
                                font: { weight: 'bold' }
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            display: true, // Mostrar números encima de las barras
                            clip: false
                        },
                        annotation: {
                            annotations: {
                                lineMean: {
                                    type: 'line',
                                    xMin: posMedia,
                                    xMax: posMedia,
                                    borderColor: 'red',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        display: true,
                                        content: `Media = ${formatSmart(P_Mues, 2)}`,
                                        position: 'end', // Top
                                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                        color: 'red',
                                        yAdjust: 0, // Top most
                                        font: { weight: 'bold' }
                                    }
                                },
                                lineMedian: {
                                    type: 'line',
                                    xMin: posMediana,
                                    xMax: posMediana,
                                    borderColor: 'blue',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        display: true,
                                        content: `Mediana = ${formatSmart(Me_Mues, 2)}`,
                                        position: 'end', // Top
                                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                        color: 'blue',
                                        yAdjust: 25, // Staggered below Mean to avoid overlap
                                        font: { weight: 'bold' }
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: nombre_variable },
                            grid: { display: false }
                        },
                        y: {
                            title: { display: true, text: 'Frecuencia' },
                            beginAtZero: true,
                            grace: '15%' // Add extra space at top for labels
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
        
        // --- FUNCIÓN PLACEHOLDER PARA EVITAR ERRORES ---
        // Esta función no estaba en el código proporcionado, la he agregado para que la app no falle.
        function analisisCualitativo(data, varName, color) {
            document.getElementById('results').innerHTML = `
                <div class="main-card p-6 fade-in error-box" style="border-color: #f59e0b; background-color: #fffbeb; color: #b45309;">
                    <h3>Función no detectada</h3>
                    <p>La función <code>analisisCualitativo</code> fue llamada pero no estaba incluida en el fragmento de código que pegaste.</p>
                </div>`;
        }
    </script>
</body>
</html>